

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>superphot.fit_model &mdash; Superphot 0.1.0.post7+gedcafcb documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Superphot
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0.post7+gedcafcb
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html">Release History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Superphot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>superphot.fit_model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for superphot.fit_model</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">tt</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">read_light_curve</span><span class="p">,</span> <span class="n">select_event_data</span><span class="p">,</span> <span class="n">filter_colors</span><span class="p">,</span> <span class="n">PHASE_MIN</span><span class="p">,</span> <span class="n">PHASE_MAX</span><span class="p">,</span> <span class="n">subplots_layout</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="c1"># Default fitting parameters</span>
<span class="n">ITERATIONS</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">TUNING</span> <span class="o">=</span> <span class="mi">25000</span>
<span class="n">WALKERS</span> <span class="o">=</span> <span class="mi">25</span>


<div class="viewcode-block" id="flux_model"><a class="viewcode-back" href="../../api.html#superphot.fit_model.flux_model">[docs]</a><span class="k">def</span> <span class="nf">flux_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">tau_rise</span><span class="p">,</span> <span class="n">tau_fall</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the flux given amplitude, plateau slope, plateau duration, start time, rise time, and fall time using</span>
<span class="sd">    theano.switch. Parameters.type = TensorType(float64, scalar).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : 1-D numpy array</span>
<span class="sd">        Time.</span>
<span class="sd">    A : TensorVariable</span>
<span class="sd">        Amplitude of the light curve.</span>
<span class="sd">    beta : TensorVariable</span>
<span class="sd">        Light curve slope during the plateau, normalized by the amplitude.</span>
<span class="sd">    gamma : TensorVariable</span>
<span class="sd">        The duration of the plateau after the light curve peaks.</span>
<span class="sd">    t_0 : TransformedRV</span>
<span class="sd">        Start time, which is very close to when the actual light curve peak flux occurs.</span>
<span class="sd">    tau_rise : TensorVariable</span>
<span class="sd">        Exponential rise time to peak.</span>
<span class="sd">    tau_fall : TensorVariable</span>
<span class="sd">        Exponential decay time after the plateau ends.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flux_model : symbolic Tensor</span>
<span class="sd">        The predicted flux from the given model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t_0</span>
    <span class="n">flux_model</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">phase</span> <span class="o">/</span> <span class="n">tau_rise</span><span class="p">))</span> <span class="o">*</span> \
        <span class="n">tt</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">phase</span> <span class="o">&lt;</span> <span class="n">gamma</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">phase</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">gamma</span> <span class="o">-</span> <span class="n">phase</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau_fall</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flux_model</span></div>


<div class="viewcode-block" id="LogUniform"><a class="viewcode-back" href="../../api.html#superphot.fit_model.LogUniform">[docs]</a><span class="k">class</span> <span class="nc">LogUniform</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">continuous</span><span class="o">.</span><span class="n">BoundedContinuous</span><span class="p">):</span>
    <span class="sa">R</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Continuous log-uniform log-likelihood.</span>

<span class="sd">    The pdf of this distribution is</span>

<span class="sd">    .. math::</span>

<span class="sd">       f(x \mid lower, upper) = \frac{1}{[\log(upper)-\log(lower)]x}</span>

<span class="sd">    .. plot::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        plt.style.use(&#39;seaborn-darkgrid&#39;)</span>
<span class="sd">        x = np.linspace(1., 300., 500)</span>
<span class="sd">        ls = [3., 150.]</span>
<span class="sd">        us = [100., 250.]</span>
<span class="sd">        for l, u in zip(ls, us):</span>
<span class="sd">            y = np.zeros(500)</span>
<span class="sd">            inside = (x&lt;u) &amp; (x&gt;l)</span>
<span class="sd">            y[inside] = 1. / ((np.log(u) - np.log(l)) * x[inside])</span>
<span class="sd">            plt.plot(x, y, label=&#39;lower = {}, upper = {}&#39;.format(l, u))</span>
<span class="sd">        plt.xlabel(&#39;x&#39;, fontsize=12)</span>
<span class="sd">        plt.ylabel(&#39;f(x)&#39;, fontsize=12)</span>
<span class="sd">        plt.legend(loc=1)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    ========  =====================================</span>
<span class="sd">    Support   :math:`x \in [lower, upper]`</span>
<span class="sd">    Mean      :math:`\dfrac{upper - lower}{\log(upper) - \log(lower)}`</span>
<span class="sd">    ========  =====================================</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lower : float</span>
<span class="sd">        Lower limit.</span>
<span class="sd">    upper : float</span>
<span class="sd">        Upper limit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">upper</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;LogUniform bounds must be positive&#39;</span><span class="p">)</span>
        <span class="n">log_lower</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
        <span class="n">log_upper</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logdist</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">log_lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">log_upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdist</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">log_upper</span> <span class="o">-</span> <span class="n">log_lower</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="LogUniform.random"><a class="viewcode-back" href="../../api.html#superphot.fit_model.LogUniform.random">[docs]</a>    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw random values from LogUniform distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        point : dict, optional</span>
<span class="sd">            Dict of variable values on which random values are to be</span>
<span class="sd">            conditioned (uses default point if not specified).</span>
<span class="sd">        size : int, optional</span>
<span class="sd">            Desired size of random sample (returns one sample if not</span>
<span class="sd">            specified).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdist</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">point</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">))</span></div>

<div class="viewcode-block" id="LogUniform.logp"><a class="viewcode-back" href="../../api.html#superphot.fit_model.LogUniform.logp">[docs]</a>    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate log-probability of LogUniform distribution at specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : numeric</span>
<span class="sd">            Value for which log-probability is calculated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TensorVariable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_value</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdist</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="n">log_value</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_value</span></div></div>


<div class="viewcode-block" id="setup_model1"><a class="viewcode-back" href="../../api.html#superphot.fit_model.setup_model1">[docs]</a><span class="k">def</span> <span class="nf">setup_model1</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">max_flux</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the PyMC3 model object, which contains the priors and the likelihood.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obs : astropy.table.Table</span>
<span class="sd">        Astropy table containing the light curve data.</span>
<span class="sd">    max_flux : float, optional</span>
<span class="sd">        The maximum flux observed in any filter. The amplitude prior is 100 * `max_flux`. If None, the maximum flux in</span>
<span class="sd">        the input table is used, even though it does not contain all the filters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : pymc3.Model</span>
<span class="sd">        PyMC3 model object for the input data. Use this to run the MCMC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs_time</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">obs_flux</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">obs_unc</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCALERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">max_flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_flux</span> <span class="o">=</span> <span class="n">obs_flux</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">max_flux</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The maximum flux is very low. Cannot fit the model.&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">LogUniform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">100.</span> <span class="o">*</span> <span class="n">max_flux</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Plateau Slope&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">BoundedNormal</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Bound</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Mixture</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Plateau Duration&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">tt</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">testval</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                           <span class="n">comp_dists</span><span class="o">=</span><span class="p">[</span><span class="n">BoundedNormal</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.</span><span class="p">),</span> <span class="n">BoundedNormal</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="mf">60.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">30.</span><span class="p">)])</span>
        <span class="n">t_0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Start Time&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">PHASE_MIN</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">PHASE_MAX</span><span class="p">)</span>
        <span class="n">tau_rise</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Rise Time&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">50.</span><span class="p">)</span>
        <span class="n">tau_fall</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Fall Time&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">300.</span><span class="p">)</span>
        <span class="n">extra_sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Intrinsic Scatter&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">tau_rise</span><span class="p">,</span> <span class="n">tau_fall</span><span class="p">]</span>

        <span class="n">exp_flux</span> <span class="o">=</span> <span class="n">flux_model</span><span class="p">(</span><span class="n">obs_time</span><span class="p">,</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">extra_sigma</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">obs_unc</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux_Posterior&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">exp_flux</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">obs_flux</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">parameters</span></div>


<div class="viewcode-block" id="make_new_priors"><a class="viewcode-back" href="../../api.html#superphot.fit_model.make_new_priors">[docs]</a><span class="k">def</span> <span class="nf">make_new_priors</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each parameter, combine the posteriors for the four filters and use that as the new prior.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    traces : dict</span>
<span class="sd">        Dictionary of MultiTrace objects for each filter.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables for which to combine the posteriors. (Only names of the parameters are used.)</span>
<span class="sd">    res : int, optional</span>
<span class="sd">        Number of points to sample the KDE for the new priors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_priors : list</span>
<span class="sd">        List of Numpy arrays containing the x-values of the new priors.</span>
<span class="sd">    y_priors : list</span>
<span class="sd">        List of Numpy arrays containing the y-values of the new priors.</span>
<span class="sd">    old_posteriors : list</span>
<span class="sd">        List of dictionaries containing the y-values of the old posteriors for each filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_priors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_priors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">old_posteriors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">trace_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">fltr</span><span class="p">:</span> <span class="n">trace</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">fltr</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">combined_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">trace_values</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">combined_trace</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">combined_trace</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">res</span><span class="p">)</span>
        <span class="n">y_comb</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">combined_trace</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_priors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y_priors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_comb</span><span class="p">)</span>
        <span class="n">old_posteriors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">,</span> <span class="n">old_posteriors</span></div>


<div class="viewcode-block" id="plot_priors"><a class="viewcode-back" href="../../api.html#superphot.fit_model.plot_priors">[docs]</a><span class="k">def</span> <span class="nf">plot_priors</span><span class="p">(</span><span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">,</span> <span class="n">old_posteriors</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">saveto</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overplot the old priors, the old posteriors in each filter, and the new priors for each parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_priors : list</span>
<span class="sd">        List of Numpy arrays containing the x-values of the new priors.</span>
<span class="sd">    y_priors : list</span>
<span class="sd">        List of Numpy arrays containing the y-values of the new priors.</span>
<span class="sd">    old_posteriors : list</span>
<span class="sd">        List of dictionaries containing the y-values of the old posteriors for each filter.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables for which to combine the posteriors.</span>
<span class="sd">    saveto : str, optional</span>
<span class="sd">        Filename to which to save the plot. If None, display the plot instead of saving it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">subplots_layout</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_comb</span><span class="p">,</span> <span class="n">trace_values</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">,</span> <span class="n">old_posteriors</span><span class="p">,</span> <span class="n">axarr</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="n">y_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flt</span><span class="p">,</span> <span class="n">trace_flt</span> <span class="ow">in</span> <span class="n">trace_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">y_filt</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">trace_flt</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_filt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">filter_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flt</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_comb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">saveto</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveto</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_model2"><a class="viewcode-back" href="../../api.html#superphot.fit_model.setup_model2">[docs]</a><span class="k">def</span> <span class="nf">setup_model2</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up a PyMC3 model for observations in a given filter using the given priors and parameter names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obs : astropy.table.Table</span>
<span class="sd">        Astropy table containing the light curve data.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables for which to create new parameters. (Only names of the parameters are used.)</span>
<span class="sd">    x_priors : list</span>
<span class="sd">        List of Numpy arrays containing the x-values of the priors.</span>
<span class="sd">    y_priors : list</span>
<span class="sd">        List of Numpy arrays containing the y-values of the priors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : pymc3.Model</span>
<span class="sd">        PyMC3 model object for the input data. Use this to run the MCMC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs_time</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">obs_flux</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">obs_unc</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCALERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">new_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">):</span>
            <span class="n">new_param</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Interpolated</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x_points</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">pdf_points</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
            <span class="n">new_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_param</span><span class="p">)</span>

        <span class="n">exp_flux</span> <span class="o">=</span> <span class="n">flux_model</span><span class="p">(</span><span class="n">obs_time</span><span class="p">,</span> <span class="o">*</span><span class="n">new_params</span><span class="p">)</span>
        <span class="n">extra_sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Intrinsic Scatter&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">extra_sigma</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">obs_unc</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux_Posterior&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">exp_flux</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">obs_flux</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">new_params</span></div>


<div class="viewcode-block" id="sample_or_load_trace"><a class="viewcode-back" href="../../api.html#superphot.fit_model.sample_or_load_trace">[docs]</a><span class="k">def</span> <span class="nf">sample_or_load_trace</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">trace_file</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">ITERATIONS</span><span class="p">,</span> <span class="n">walkers</span><span class="o">=</span><span class="n">WALKERS</span><span class="p">,</span> <span class="n">tuning</span><span class="o">=</span><span class="n">TUNING</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a Metropolis Hastings MCMC for the given model with a certain number iterations, burn in (tuning), and walkers.</span>

<span class="sd">    If the MCMC has already been run, read and return the existing trace (unless `force=True`).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : pymc3.Model</span>
<span class="sd">        PyMC3 model object for the input data.</span>
<span class="sd">    trace_file : str</span>
<span class="sd">        Path where the trace will be stored. If this path exists, load the trace from there instead.</span>
<span class="sd">    force : bool, optional</span>
<span class="sd">        Resample the model even if `trace_file` already exists.</span>
<span class="sd">    iterations : int, optional</span>
<span class="sd">        The number of iterations after tuning.</span>
<span class="sd">    walkers : int, optional</span>
<span class="sd">        The number of cores and walkers used.</span>
<span class="sd">    tuning : int, optional</span>
<span class="sd">        The number of iterations used for tuning.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trace : pymc3.MultiTrace</span>
<span class="sd">        The PyMC3 trace object for the MCMC run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">trace_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">trace_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting fit for </span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">tuning</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">walkers</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">walkers</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">Metropolis</span><span class="p">())</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">save_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">trace_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">load_trace</span><span class="p">(</span><span class="n">trace_file</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded trace from </span><span class="si">{</span><span class="n">trace_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trace</span></div>


<div class="viewcode-block" id="produce_lc"><a class="viewcode-back" href="../../api.html#superphot.fit_model.produce_lc">[docs]</a><span class="k">def</span> <span class="nf">produce_lc</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">align_to_t0</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the stored PyMC3 traces and produce model light curves from the parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    time : numpy.array</span>
<span class="sd">        Range of times (in days, with respect to PEAKMJD) over which the model should be calculated.</span>
<span class="sd">    trace : numpy.array</span>
<span class="sd">        PyMC3 trace stored as an array, with parameters as the last dimension.</span>
<span class="sd">    align_to_t0 : bool, optional</span>
<span class="sd">        Interpret `time` as days with respect to t_0 instead of PEAKMJD.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lc : numpy.array</span>
<span class="sd">        Model light curves. Time is the last dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tt</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">compute_test_value</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span>
    <span class="n">mytensor</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">TensorType</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kc">True</span><span class="p">,))</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">mytensor</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">flux_model</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">param_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))}</span>
    <span class="k">if</span> <span class="n">align_to_t0</span><span class="p">:</span>
        <span class="n">param_values</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">param_values</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lc</span></div>


<div class="viewcode-block" id="plot_model_lcs"><a class="viewcode-back" href="../../api.html#superphot.fit_model.plot_model_lcs">[docs]</a><span class="k">def</span> <span class="nf">plot_model_lcs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fltr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_min</span><span class="o">=</span><span class="n">PHASE_MIN</span><span class="p">,</span>
                   <span class="n">phase_max</span><span class="o">=</span><span class="n">PHASE_MAX</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot sample light curves from a fit compared to the observations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obs : astropy.table.Table</span>
<span class="sd">        Astropy table containing the observed light curve in a single filter.</span>
<span class="sd">    trace : pymc3.MultiTrace</span>
<span class="sd">        PyMC3 trace object containing values for the fit parameters.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables in the PyMC3 model.</span>
<span class="sd">    size : int, optional</span>
<span class="sd">        Number of draws from the posterior to plot. Default: 100.</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        Axes object on which to plot the light curves. If None, create new Axes.</span>
<span class="sd">    fltr : str, optional</span>
<span class="sd">        Filter these data were observed in. Only used to label and color the plot.</span>
<span class="sd">    ls : str, optional</span>
<span class="sd">        Line style for the model light curves. Default: solid line.</span>
<span class="sd">    phase_min, phase_max : float, optional</span>
<span class="sd">        Time range over which to plot the light curves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">phase_min</span><span class="p">,</span> <span class="n">phase_max</span><span class="p">)</span>
    <span class="n">trace_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">trace_values</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">produce_lc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">filter_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fltr</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCALERR&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">phase_min</span> <span class="o">-</span> <span class="mf">9.</span><span class="p">,</span> <span class="n">phase_max</span> <span class="o">+</span> <span class="mf">9.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fltr</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">fltr</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

    <span class="c1"># autoscale y-axis without errorbars</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.08</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.08</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_final_fits"><a class="viewcode-back" href="../../api.html#superphot.fit_model.plot_final_fits">[docs]</a><span class="k">def</span> <span class="nf">plot_final_fits</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">traces1</span><span class="p">,</span> <span class="n">traces2</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a four-panel plot showing sample light curves from each of the two fitting iterations compared to observations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : astropy.table.Table</span>
<span class="sd">        Astropy table containing the observed light curve.</span>
<span class="sd">    traces1, traces2 : dict</span>
<span class="sd">        Dictionaries of the trace objects (for each filter) from which to generate the model light curves.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables in the PyMC3 model.</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        Filename to which to save the plot. If None, display the plot instead of saving it.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        Figure object for the plot (can be added to a multipage PDF).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">subplots_layout</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces1</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outfile</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fltr</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traces1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fltr</span><span class="p">]</span>
        <span class="n">plot_model_lcs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">traces1</span><span class="p">[</span><span class="n">fltr</span><span class="p">],</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fltr</span><span class="o">=</span><span class="n">fltr</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">plot_model_lcs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">traces2</span><span class="p">[</span><span class="n">fltr</span><span class="p">],</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fltr</span><span class="o">=</span><span class="n">fltr</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">w_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="diagnostics"><a class="viewcode-back" href="../../api.html#superphot.fit_model.diagnostics">[docs]</a><span class="k">def</span> <span class="nf">diagnostics</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make some diagnostic plots for the PyMC3 fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obs : astropy.table.Table</span>
<span class="sd">        Observed light curve data in a single filter.</span>
<span class="sd">    trace : pymc3.MultiTrace</span>
<span class="sd">        Trace object that is the result of the PyMC3 fit.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables in the PyMC3 model.</span>
<span class="sd">    filename : str, optional</span>
<span class="sd">        Directory in which to save the output plots and summary. Not used if `show=True`.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        If True, show the plots instead of saving them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">))</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hexbin&#39;</span><span class="p">,</span> <span class="n">contour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">textsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">textsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

    <span class="n">f4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plot_model_lcs</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;summary.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;trace.pdf&#39;</span><span class="p">))</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;corner.pdf&#39;</span><span class="p">))</span>
        <span class="n">f3</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;posterior.pdf&#39;</span><span class="p">))</span>
        <span class="n">f4</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;lightcurve.pdf&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="two_iteration_mcmc"><a class="viewcode-back" href="../../api.html#superphot.fit_model.two_iteration_mcmc">[docs]</a><span class="k">def</span> <span class="nf">two_iteration_mcmc</span><span class="p">(</span><span class="n">light_curve</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_second</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">iterations</span><span class="o">=</span><span class="n">ITERATIONS</span><span class="p">,</span> <span class="n">walkers</span><span class="o">=</span><span class="n">WALKERS</span><span class="p">,</span> <span class="n">tuning</span><span class="o">=</span><span class="n">TUNING</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the model to the observed light curve. Then combine the posteriors for each filter and use that as the new prior</span>
<span class="sd">    for a second iteration of fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    light_curve : astropy.table.Table</span>
<span class="sd">        Astropy table containing the observed light curve.</span>
<span class="sd">    outfile : str</span>
<span class="sd">        Path where the trace will be stored. This should include a blank field ({{}}) that will be replaced with the </span>
<span class="sd">        iteration number and filter name. Diagnostic plots will also be saved according to this pattern.</span>
<span class="sd">    filters : str, optional</span>
<span class="sd">        Light curve filters to fit. Default: all filters in `light_curve`.</span>
<span class="sd">    force : bool, optional</span>
<span class="sd">        Redo the fit (both iterations) even if results are already stored in `outfile`. Default: False.</span>
<span class="sd">    force_second : bool, optional</span>
<span class="sd">        Redo only the second iteration of the fit, even if the results are already stored in `outfile`. Default: False.</span>
<span class="sd">    do_diagnostics : bool, optional</span>
<span class="sd">        Produce and save some diagnostic plots. Default: True.</span>
<span class="sd">    iterations : int, optional</span>
<span class="sd">        The number of iterations after tuning.</span>
<span class="sd">    walkers : int, optional</span>
<span class="sd">        The number of cores and walkers used.</span>
<span class="sd">    tuning : int, optional</span>
<span class="sd">        The number of iterations used for tuning.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    traces1, traces2 : dict</span>
<span class="sd">        Dictionaries of the PyMC3 trace objects for each filter for the first and second fitting iterations.</span>
<span class="sd">    parameters : list</span>
<span class="sd">        List of Theano variables in the PyMC3 model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">select_event_data</span><span class="p">(</span><span class="n">light_curve</span><span class="p">)</span>
    <span class="n">traces1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lc_filters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLT&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filters_to_fit</span> <span class="o">=</span> <span class="n">lc_filters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filters_to_fit</span> <span class="o">=</span> <span class="n">lc_filters</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters_to_fit</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;None of the requested filters (</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="si">}</span><span class="s1">) &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;are in your light curve (</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lc_filters</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fltr</span> <span class="ow">in</span> <span class="n">filters_to_fit</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fltr</span><span class="p">]</span>
        <span class="n">model1</span><span class="p">,</span> <span class="n">parameters1</span> <span class="o">=</span> <span class="n">setup_model1</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">outfile1</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span> <span class="o">+</span> <span class="n">fltr</span><span class="p">)</span>
        <span class="n">trace1</span> <span class="o">=</span> <span class="n">sample_or_load_trace</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="n">outfile1</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">walkers</span><span class="p">,</span> <span class="n">tuning</span><span class="p">)</span>
        <span class="n">traces1</span><span class="p">[</span><span class="n">fltr</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace1</span>
        <span class="k">if</span> <span class="n">do_diagnostics</span><span class="p">:</span>
            <span class="n">diagnostics</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace1</span><span class="p">,</span> <span class="n">parameters1</span><span class="p">,</span> <span class="n">outfile1</span><span class="p">)</span>

    <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">,</span> <span class="n">old_posteriors</span> <span class="o">=</span> <span class="n">make_new_priors</span><span class="p">(</span><span class="n">traces1</span><span class="p">,</span> <span class="n">parameters1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_diagnostics</span><span class="p">:</span>
        <span class="n">plot_priors</span><span class="p">(</span><span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">,</span> <span class="n">old_posteriors</span><span class="p">,</span> <span class="n">parameters1</span><span class="p">,</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_priors.pdf&#39;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting second iteration of fitting&#39;</span><span class="p">)</span>

    <span class="n">traces2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fltr</span> <span class="ow">in</span> <span class="n">filters_to_fit</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fltr</span><span class="p">]</span>
        <span class="n">model2</span><span class="p">,</span> <span class="n">parameters2</span> <span class="o">=</span> <span class="n">setup_model2</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">parameters1</span><span class="p">,</span> <span class="n">x_priors</span><span class="p">,</span> <span class="n">y_priors</span><span class="p">)</span>
        <span class="n">outfile2</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_2&#39;</span> <span class="o">+</span> <span class="n">fltr</span><span class="p">)</span>
        <span class="n">trace2</span> <span class="o">=</span> <span class="n">sample_or_load_trace</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">outfile2</span><span class="p">,</span> <span class="n">force</span> <span class="ow">or</span> <span class="n">force_second</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">walkers</span><span class="p">,</span> <span class="n">tuning</span><span class="p">)</span>
        <span class="n">traces2</span><span class="p">[</span><span class="n">fltr</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace2</span>
        <span class="k">if</span> <span class="n">do_diagnostics</span><span class="p">:</span>
            <span class="n">diagnostics</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace2</span><span class="p">,</span> <span class="n">parameters2</span><span class="p">,</span> <span class="n">outfile2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">traces1</span><span class="p">,</span> <span class="n">traces2</span><span class="p">,</span> <span class="n">parameters2</span></div>


<span class="k">def</span> <span class="nf">plot_diagnostics</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to PyMC3 trace directory&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snana-path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to SNANA files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--show&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show the plots instead of saving to a file&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ps1id</span><span class="p">,</span> <span class="n">fltr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">fltr</span> <span class="o">=</span> <span class="n">fltr</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;12&#39;</span><span class="p">)</span>
    <span class="n">snana_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">snana_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PS1_PS1MD_</span><span class="si">{</span><span class="n">ps1id</span><span class="si">}</span><span class="s1">.snana.dat&#39;</span><span class="p">)</span>
    <span class="n">t_full</span> <span class="o">=</span> <span class="n">read_light_curve</span><span class="p">(</span><span class="n">snana_file</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">select_event_data</span><span class="p">(</span><span class="n">t_full</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fltr</span><span class="p">]</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">setup_model1</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;FLUXCAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">load_trace</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">diagnostics</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;filenames&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input SNANA files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--filters&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Subset of filters to fit&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--iterations&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ITERATIONS</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of steps after burn-in&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tuning&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">TUNING</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of burn-in steps&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--walkers&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">WALKERS</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of walkers&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output-dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path in which to save the PyMC3 trace data&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--zmin&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not fit the transient if redshift &lt;= zmin in the header&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;redo the fit even if the trace is already saved&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-2&#39;</span><span class="p">,</span> <span class="s1">&#39;--force-second&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;redo only the second iteration of fitting even if the trace is already saved&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plots&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save some diagnostic plots&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">pdf</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="s1">&#39;lc_fits.pdf&#39;</span><span class="p">,</span> <span class="n">keep_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">filenames</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">light_curve</span> <span class="o">=</span> <span class="n">read_light_curve</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">light_curve</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">zmin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping file with redshift </span><span class="si">{</span><span class="n">light_curve</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;REDSHIFT&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">traces1</span><span class="p">,</span> <span class="n">traces2</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">two_iteration_mcmc</span><span class="p">(</span><span class="n">light_curve</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                                                          <span class="n">force_second</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force_second</span><span class="p">,</span> <span class="n">do_diagnostics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">plots</span><span class="p">,</span>
                                                          <span class="n">iterations</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span> <span class="n">walkers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">walkers</span><span class="p">,</span>
                                                          <span class="n">tuning</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tuning</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_final_fits</span><span class="p">(</span><span class="n">light_curve</span><span class="p">,</span> <span class="n">traces1</span><span class="p">,</span> <span class="n">traces2</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">))</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Griffin Hosseinzadeh &amp; Frederick Dauphin

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>